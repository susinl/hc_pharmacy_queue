<?php
	function status_bar($s_id){
		if($s_id == 10){
			echo
			'<span class="w3-tag w3-round-xlarge w3-blue w3-center" style="width: 60px;"><i class="fa fa-clock-o" aria-hidden="true"></i></span>
        	<span class="w3-tag w3-round-xlarge w3-light-grey w3-center" style="width: 60px;"><i class="fa fa-balance-scale" aria-hidden="true"></i></span>
        	<span class="w3-tag w3-round-xlarge w3-light-grey w3-center" style="width: 60px;"><i class="fa fa-clock-o" aria-hidden="true"></i></span>
        	<span class="w3-tag w3-round-xlarge w3-light-grey w3-center" style="width: 60px;"><i class="fa fa-fire" aria-hidden="true"></i></span>
        	<span class="w3-tag w3-round-xlarge w3-light-grey w3-center" style="width: 60px;"><i class="fa fa-check-circle" aria-hidden="true"></i></span>';
		}
		if($s_id == 11){
			echo
			'<span class="w3-tag w3-round-xlarge w3-light-blue w3-center" style="width: 60px;"><i class="fa fa-clock-o" aria-hidden="true"></i></span>
        	<span class="w3-tag w3-round-xlarge w3-blue w3-center" style="width: 60px;"><i class="fa fa-balance-scale" aria-hidden="true"></i></span>
        	<span class="w3-tag w3-round-xlarge w3-light-grey w3-center" style="width: 60px;"><i class="fa fa-clock-o" aria-hidden="true"></i></span>
        	<span class="w3-tag w3-round-xlarge w3-light-grey w3-center" style="width: 60px;"><i class="fa fa-fire" aria-hidden="true"></i></span>
        	<span class="w3-tag w3-round-xlarge w3-light-grey w3-center" style="width: 60px;"><i class="fa fa-check-circle" aria-hidden="true"></i></span>';
		}
		if($s_id == 12){
			echo
			'<span class="w3-tag w3-round-xlarge w3-light-blue w3-center" style="width: 60px;"><i class="fa fa-clock-o" aria-hidden="true"></i></span>
        	<span class="w3-tag w3-round-xlarge w3-light-blue w3-center" style="width: 60px;"><i class="fa fa-balance-scale" aria-hidden="true"></i></span>
        	<span class="w3-tag w3-round-xlarge w3-blue w3-center" style="width: 60px;"><i class="fa fa-clock-o" aria-hidden="true"></i></span>
        	<span class="w3-tag w3-round-xlarge w3-light-grey w3-center" style="width: 60px;"><i class="fa fa-fire" aria-hidden="true"></i></span>
        	<span class="w3-tag w3-round-xlarge w3-light-grey w3-center" style="width: 60px;"><i class="fa fa-check-circle" aria-hidden="true"></i></span>';
		}
		if($s_id == 13 | $s_id == 14){
			echo
			'<span class="w3-tag w3-round-xlarge w3-light-blue w3-center" style="width: 60px;"><i class="fa fa-clock-o" aria-hidden="true"></i></span>
        	<span class="w3-tag w3-round-xlarge w3-light-blue w3-center" style="width: 60px;"><i class="fa fa-balance-scale" aria-hidden="true"></i></span>
        	<span class="w3-tag w3-round-xlarge w3-light-blue w3-center" style="width: 60px;"><i class="fa fa-clock-o" aria-hidden="true"></i></span>
        	<span class="w3-tag w3-round-xlarge w3-blue w3-center" style="width: 60px;"><i class="fa fa-fire" aria-hidden="true"></i></span>
        	<span class="w3-tag w3-round-xlarge w3-light-grey w3-center" style="width: 60px;"><i class="fa fa-check-circle" aria-hidden="true"></i></span>';
		}
		if($s_id == 15 | $s_id == 16){
			echo
			'<span class="w3-tag w3-round-xlarge w3-light-blue w3-center" style="width: 60px;"><i class="fa fa-clock-o" aria-hidden="true"></i></span>
        	<span class="w3-tag w3-round-xlarge w3-light-blue w3-center" style="width: 60px;"><i class="fa fa-balance-scale" aria-hidden="true"></i></span>
        	<span class="w3-tag w3-round-xlarge w3-light-blue w3-center" style="width: 60px;"><i class="fa fa-clock-o" aria-hidden="true"></i></span>
        	<span class="w3-tag w3-round-xlarge w3-light-blue w3-center" style="width: 60px;"><i class="fa fa-fire" aria-hidden="true"></i></span>
        	<span class="w3-tag w3-round-xlarge w3-red w3-center" style="width: 60px;"><i class="fa fa-check-circle" aria-hidden="true"></i></span>';
		}
		if($s_id == 20 | $s_id == 30){
			echo
			'<span class="w3-tag w3-round-xlarge w3-blue w3-center" style="width: 60px;"><i class="fa fa-clock-o" aria-hidden="true"></i></span>
        	<span class="w3-tag w3-round-xlarge w3-white w3-center" style="width: 60px;"></span>
        	<span class="w3-tag w3-round-xlarge w3-light-grey w3-center" style="width: 60px;"><i class="fa fa-balance-scale" aria-hidden="true"></i></span>
        	<span class="w3-tag w3-round-xlarge w3-white w3-center" style="width: 60px;"></span>
        	<span class="w3-tag w3-round-xlarge w3-light-grey w3-center" style="width: 60px;"><i class="fa fa-check-circle" aria-hidden="true"></i></span>';
		}
		if($s_id == 21 | $s_id == 22 | $s_id == 31){
			echo
			'<span class="w3-tag w3-round-xlarge w3-light-blue w3-center" style="width: 60px;"><i class="fa fa-clock-o" aria-hidden="true"></i></span>
        	<span class="w3-tag w3-round-xlarge w3-white w3-center" style="width: 60px;"></span>
        	<span class="w3-tag w3-round-xlarge w3-blue w3-center" style="width: 60px;"><i class="fa fa-balance-scale" aria-hidden="true"></i></span>
        	<span class="w3-tag w3-round-xlarge w3-white w3-center" style="width: 60px;"></span>
        	<span class="w3-tag w3-round-xlarge w3-light-grey w3-center" style="width: 60px;"><i class="fa fa-check-circle" aria-hidden="true"></i></span>';
		}
		if($s_id == 23 | $s_id == 24 | $s_id == 32 | $s_id ==33){
			echo
			'<span class="w3-tag w3-round-xlarge w3-light-blue w3-center" style="width: 60px;"><i class="fa fa-clock-o" aria-hidden="true"></i></span>
        	<span class="w3-tag w3-round-xlarge w3-white w3-center" style="width: 60px;"></span>
        	<span class="w3-tag w3-round-xlarge w3-light-blue w3-center" style="width: 60px;"><i class="fa fa-balance-scale" aria-hidden="true"></i></span>
        	<span class="w3-tag w3-round-xlarge w3-white w3-center" style="width: 60px;"></span>
        	<span class="w3-tag w3-round-xlarge w3-red w3-center" style="width: 60px;"><i class="fa fa-check-circle" aria-hidden="true"></i></span>';
		}
	}

	function type_process_icon($t_id){
		if($t_id == 1){
			echo
			'<span class="w3-tag w3-round-xlarge w3-light-grey w3-center" style="width: 60px;"><i class="fa fa-clock-o" aria-hidden="true"></i></span> รอจัดยา
        	<span class="w3-tag w3-round-xlarge w3-light-grey w3-center" style="width: 60px;"><i class="fa fa-balance-scale" aria-hidden="true"></i></span> จัดยา
        	<span class="w3-tag w3-round-xlarge w3-light-grey w3-center" style="width: 60px;"><i class="fa fa-clock-o" aria-hidden="true"></i></span> รอต้มยา
        	<span class="w3-tag w3-round-xlarge w3-light-grey w3-center" style="width: 60px;"><i class="fa fa-fire" aria-hidden="true"></i></span> ต้มยา
        	<span class="w3-tag w3-round-xlarge w3-light-grey w3-center" style="width: 60px;"><i class="fa fa-check-circle" aria-hidden="true"></i></span> เสร็จ';
		}
		if($t_id == 2 | $t_id == 3){
			echo
			'<span class="w3-tag w3-round-xlarge w3-light-grey w3-center" style="width: 60px;"><i class="fa fa-clock-o" aria-hidden="true"></i></span> รอจัดยา
        	<span class="w3-tag w3-round-xlarge w3-light-grey w3-center" style="width: 60px;"><i class="fa fa-clock-o" aria-hidden="true"></i></span> จัดยา
        	<span class="w3-tag w3-round-xlarge w3-light-grey w3-center" style="width: 60px;"><i class="fa fa-check-circle" aria-hidden="true"></i></span> เสร็จ';
        }
	}
		function type_process($t_id){
		if($t_id == 1){
			echo
			'<span class="w3-tag w3-round-large w3-blue w3-center" > รอจัดยา </span> <i class="fa fa-arrow-right" aria-hidden="true"></i>
        	<span class="w3-tag w3-round-large w3-blue w3-center" > จัดยา </span> <i class="fa fa-arrow-right" aria-hidden="true"></i>
        	<span class="w3-tag w3-round-large w3-blue w3-center" > รอต้มยา </span> <i class="fa fa-arrow-right" aria-hidden="true"></i>
        	<span class="w3-tag w3-round-large w3-blue w3-center" > ต้มยา </span> <i class="fa fa-arrow-right" aria-hidden="true"></i>
        	<span class="w3-tag w3-round-large w3-blue w3-center" > เสร็จ </span> ';
		}
		if($t_id == 2 | $t_id == 3){
			echo
			'<span class="w3-tag w3-round-large w3-blue w3-center" > รอจัดยา </span> <i class="fa fa-arrow-right" aria-hidden="true"></i>
        	<span class="w3-tag w3-round-large w3-blue w3-center" > จัดยา </span> <i class="fa fa-arrow-right" aria-hidden="true"></i>
        	<span class="w3-tag w3-round-large w3-blue w3-center" > เสร็จ </span> ';
        }
	}

	function finish_table($db, $fin_s_id, $fin, $today, $title){ 
			// ใช้แสดงคิวที่เสร็จแล้ว ต้องใส่ค่อ 
			//$fin_s_id ซึ่งคือ id ที่แปลว่าพร้อมจ่ายยา, $title เป็นชื่อหัวข้อของตาราง, $today เป็นวันที่อยู่ใน format 'yyyy-mm-dd'
            // การทำงาน
            // 1. เลือกใบยาที่เสร็จแล้วออกมาจากระบบ
            // 2. ดึงแถวแรกออกมาแล้วเช็คว่าเป็นใบยาที่ต้องแสดงไหมจาก array ของยิม
            // 3. ดูว่าเสร็จทุกใบจริง ๆ แล้วยัง
            // 4. ถ้าเสร็จทุกใบแล้ว เอาไปพิมพ์ลงตาราง
            // 5. กลับไปเริ่มใหม่ที่ข้อ 2
        	//1.
        	$query1 = "SELECT p.pre_id, p.q_id, q.q_name 
						FROM ieproject.dbo.prescription as p, ieproject.dbo.queue as q 
						WHERE p.q_id = q.q_id 
						AND p.in_datetime > '$today' 
						AND p.in_datetime <= dateadd(day, 1, '$today') 
						AND p.s_id = '$fin_s_id' 
							ORDER BY p.q_id;";
        	$result = odbc_exec($db, $query1);
    	
         	// เขียนเรื่องให้มันไปอีกหน้าถ้าล้น
    		$item = 1; //ตอนนี้กำลังจะพิมพ์ตัวที่ item ใน 1 แถวจะมี 3 ตัว ใน 1 หน้ามี 18 ตัว

        	while ($list = odbc_fetch_array($result)){ //ดึงแถวแรกออกมา
        		$pre_id = $list['pre_id'];
        		$q_id = $list['q_id'];
        		$q_name = $list['q_name'];
        		//2.
        		//if(in_array($pre_id, $fin)){

            		//3.Check if there is any prescription with the same q_id that isn't finished.
            		$finished_all = 1;
            		$s_id_finish = array(15, 16, 23, 24, 32, 33, 40); //finish status
            		$query2 = "SELECT * FROM prescription where q_id = '$q_id';";
            		$result2 = odbc_exec($db, $query2);
            		while ($list2 = odbc_fetch_array($result2)) {
            			$check_s_id = $list2['s_id']; //ดูว่า s_id ของใบยาอื่น ๆ เสร็จหรือยัง
            			if (!in_array($check_s_id, $s_id_finish)){
            				$finished_all = 0;
            			}
            		}

            		//4.
            		if($finished_all==1){ //if all is finish
            			$mod3 = $item%3;
            			$mod18 = $item%18;
            			if($mod18 == 1 && $item != 1){ //ขึ้นหน้าใหม่ถ้าตัวต่อไปที่จะพิมพ์ ถ้า mod18 = 1 ก็คืเอเป็นตัวแรกของหน้า
		        			// ปิด table, div ที่เป็น slide
		        			echo 	"	</table>
		        					</div>";
		        			// เปิด div เขียนชนิดยา และเปิดตาราง
		        			echo 	
		        			'<div class="w3-animate-right mySlides">
		        				<h1 class="w3-center">'.$title.'</h3>
		            			<table class="w3-table w3-striped-red w3-xxxlarge">';
		        		}
            			
            			if($mod3 == 1){//ตัวแรกงของแถว
            				echo "<tr><td><b>".$q_name."</b></td>";
            				$item++;
            			}
            			if($mod3 == 2){//ตัวที่สองของแถว
            				echo "<td><b>".$q_name."</b></td>";
            				$item++;
            			}
            			if($mod3 == 0){
            				echo "<td><b>".$q_name."</b></td></tr>";
            				$item++;
            			}
            		}
            	//}
        	}

       		//พิพม์ครบแล้วต้องเช็คว่าอยู่ตัวที่เท่าไหร่จะได้ปิดตารางได้ครบ
        	$mod3 = $item%3;
        	if($mod3 == 1){ //ถ้าจะพิมพ์ตัวที่ 1 ของแถว ไม่ต้องปิดตารางเพราะเพิ่งปิดไป
			}
			else if($mod3 == 2){//เพิ่งพิมพ์ตัวแรกไปต้องพิมพ์อีก 2 ตัวเพื่อปิด
				echo "<td></td><td></td></tr>";
			}
			else if($mod3 == 0){ //พิมพ์ไปแล้ว 2 ตัวกำลังจะพิมพ์ตัวที่ 3 ดังนั้นต้องเอาอีก 1 ตัวแล้วค่อยปิด
				echo "<td></td></tr>";
			}
		}

	function display_status($db, $fin_s_id, $collected_s_id, $cancle_s_id, $t_id, $title, $today, $language) {
		$query1 = "SELECT p.pre_id, p.q_id, q.q_name, p.finishtime, p.s_id, s.s_display_thai, s.s_display, p.in_datetime, p.t_id
					FROM ieproject.dbo.prescription as p, ieproject.dbo.queue as q, status as s
					WHERE p.q_id = q.q_id 
					AND p.s_id = s.s_id
					AND p.in_datetime > '$today' 
					AND p.in_datetime <= dateadd(day, 1, '$today') 
					AND p.s_id != '$fin_s_id'
					AND p.s_id != '$collected_s_id'
					AND p.s_id != '$cancle_s_id'
					AND p.t_id = '$t_id'
						ORDER BY p.q_id;";
    	$result = odbc_exec($db, $query1);
     	// เขียนเรื่องให้มันไปอีกหน้าถ้าล้น
		$item = 1; //ตอนนี้กำลังจะพิมพ์ตัวที่ item ใน 1 แถวจะมี 3 ตัว ใน 1 หน้ามี 18 ตัว
    	while ($list = odbc_fetch_array($result)){ //ดึงแถวแรกออกมา
    		$pre_id = $list['pre_id'];
    		$q_id = $list['q_id'];
    		$q_name = $list['q_name'];
    		// $finishtime = $list['finishtime'];
    		$in_datetime = $list['in_datetime'];
    		$t_id = $list['t_id'];
    		$s_id = $list['s_id'];
    		$s_display = $list['s_display'];
    		$s_display_thai = iconv('TIS-620', 'UTF-8', $list['s_display_thai']);
    		//2.
    		//if(in_array($pre_id, $wip)){
        		//3.ถ้าเป็นตัวที่ขึ้นหน้าใหม่ ปิดตาราง div และขึ้น div ใหม่
    			$mod5 = $item%5;
    			if($mod5 == 1 && $item != 1){ //ขึ้นหน้าใหม่ถ้าตัวต่อไปที่จะพิมพ์ ถ้า mod5 = 1 ก็คืเอเป็นตัวแรกของหน้า
        			// ปิด table, div ที่เป็น slide
        			echo 	"	</table>
        					</div>";
        			// เปิด div เขียนชนิดยา เปิดตาราง และหัวข้อ
        			echo 	
        			'<div class="w3-animate-right mySlides2">
						<h1 class="w3-center">'.$title.'</h1>
						<h2 class="w3-center">';
        			type_process($t_id);
        			echo '</h2>
						<table class="w3-table w3-center w3-padding w3-striped-blue w3-xxxlarge">
	                        <tr class="w3-blue w3-medium">
	                            <th>คิว</th>
	                            <th>รับได้เวลาประมาณ</th>
	                            <th>สถานะ</th>
	                        </tr>';
        		}

    			//4.พิมพ์ยาตัวนี้
    			//าษาอังกฤษ
    			if($language == "eng"){
    				$in_time = strtotime($in_datetime);
	    			if ($in_time >= strtotime('14:30:00') && $t_id ==1){
	    				$s_display = "Next day";
	    			}
	    			echo 
	    			'<tr>
	                    <th>'.$q_name.'</th>
	                    <td></td>
	                    <td>'.$s_display.'</td>
	                </tr>
	    			';
                    $item++;
    			}
    			if($language == "th"){
	    			$in_time = strtotime($in_datetime);
	    			if ($in_time >= strtotime('14:30:00') && $t_id ==1){
	    				$s_display_thai = "โปรดรับวันรุ่งขึ้น";
	    			}
	    			echo 
	    			'<tr>
	                    <th>'.$q_name.'</th>
	                    <td></td>
	                    <td>'.$s_display_thai.'</td>
	                </tr>
	    			';
	    			$item++;
    			}
        	//}
		}
    }

  //   function refresh_time($db, $today){
  //   	// Find the refresh time for the display.php
  //   	// input $db: connection variable, $today: date of today in 'yyyy-mm-dd'
  //   	// 1. find the number of prescription that still in the preparing process; ($numOfWIP)
  //   	// 2. find the number of prescription that is finished; ($numOfFin)
  //   	// 3. find the display for preparing (10 seconds per page; 5 queues per page)
  //   	$query1 = "SELECT count(p.pre_id) as numOfwip
		// 			FROM ieproject.dbo.prescription as p
		// 			WHERE 
		// 			p.in_datetime > '2017-03-28' 
		// 			AND p.in_datetime <= dateadd(day, 1, '2017-03-28') 
		// 			AND p.s_id != '15'
		// 			AND p.s_id != '16'
		// 			AND p.s_id != '23'
		// 			AND p.s_id != '24'
		// 			AND p.s_id != '32'
		// 			AND p.s_id != '33'
		// 			AND p.s_id != '40'
		// 			AND p.s_id != '41';"
		// $result1 = odbc_exec($db, $query1);
		// if ($list1 = odbc_fetch_array($result1)){
		// 	$numOfwip = $list1['numOfwip'];
		// }
		// $timeWIP = max(45, $numOfwip)
  //   	return $result;
  //   }

	// function dis_status_thai($s_id, $db){
 //            $query = "SELECT s_display_thai FROM status WHERE s_id = $s_id;";
 //            $result = odbc_exec($db, $query);
 //            $icon = '';
 //            $display = "error";
 //            if ($list = odbc_fetch_array($result)){
 //                $display = iconv('TIS-620', 'UTF-8', $list['s_display_thai']);
 //                if ($display == 'รอจัด' | $display == 'รอต้ม') $icon= "<i class='fa fa-clock-o' aria-hidden='true'></i>";
 //                if ($display == 'กำลังจัดยา') $icon = "<i class='fa fa-balance-scale' aria-hidden='true'></i>";
 //                if ($display == 'กำลังต้ม') $icon = "<i class='fa fa-fire' aria-hidden='true'></i>";
 //                if ($display == 'เชิญรับยา') $icon = "<i class='fa fa-check-circle' aria-hidden='true'></i>"; 
 //                if ($display == 'ยกเลิก') $icon = "<i class='fa fa-times' aria-hidden='true'></i>";
 //                if ($display == 'โปรดติดต่อการเงิน') $icon = "<i class='fa fa-comment-o' aria-hidden='true'></i>";
 //            }
 //            $result =$icon." ".$display;
 //            echo $result;
 //    }


?>
